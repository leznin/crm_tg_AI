# Настройка Telegram Business Accounts

## Обзор

Интеграция с Telegram Business Accounts позволяет:
- Управлять несколькими бизнес-аккаунтами из одного интерфейса
- Получать и отправлять сообщения через Telegram Bot API
- Поддерживать текст, фото, документы и файлы
- Автоматически сохранять историю переписки
- Создавать карточки клиентов на основе диалогов

## Архитектура

### Backend
- **Модели**: `BusinessAccount`, `BusinessChat`, `BusinessMessage`
- **API**: `/api/v1/business-accounts/*` - управление аккаунтами и сообщениями
- **Webhook**: `/api/v1/telegram/webhook` - прием обновлений от Telegram
- **Файлы**: `/api/v1/files/*` - загрузка и отправка файлов

### Frontend
- **BusinessChatWindow**: Основное окно чата с поддержкой файлов
- **BusinessChatList**: Список бизнес-аккаунтов и диалогов
- **AppContext**: Интеграция с API для управления состоянием

## Настройка

### 1. Backend
Миграции уже применены. Убедитесь, что сервер запущен:
```bash
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. Telegram Bot
1. Создайте бота через @BotFather
2. Получите токен бота
3. Добавьте токен в настройки CRM (Settings → API Configuration)

### 3. Настройка Webhook
Установите webhook для получения обновлений:
```bash
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://your-domain.com/api/v1/telegram/webhook"}'
```

### 4. Подключение Business Account
1. В Telegram перейдите в настройки бизнес-аккаунта
2. Добавьте вашего бота как помощника
3. Бот автоматически появится в списке бизнес-аккаунтов в CRM

## Использование

### Интерфейс
1. Откройте страницу "Чаты" в CRM
2. Выберите бизнес-аккаунт из списка слева
3. Выберите диалог для просмотра сообщений
4. Отправляйте текстовые сообщения и файлы

### API Endpoints

#### Получить список бизнес-аккаунтов
```
GET /api/v1/business-accounts/
```

#### Получить диалоги аккаунта
```
GET /api/v1/business-accounts/{account_id}/chats
```

#### Получить сообщения диалога
```
GET /api/v1/business-accounts/chats/{chat_id}/messages?limit=50&offset=0
```

#### Отправить сообщение
```
POST /api/v1/business-accounts/send-message
{
  "business_connection_id": "...",
  "chat_id": 123,
  "text": "Привет!"
}
```

#### Загрузить файл
```
POST /api/v1/files/upload-to-telegram
Content-Type: multipart/form-data
file: [binary data]
```

## Особенности

### Поддерживаемые типы сообщений
- **text**: Текстовые сообщения
- **photo**: Фотографии с подписью
- **document**: Документы и файлы
- **voice**: Голосовые сообщения (только входящие)
- **video**: Видео с подписью

### Автоматизация
- Входящие сообщения автоматически сохраняются в базе данных
- Счетчик непрочитанных обновляется в реальном времени
- Карточки клиентов создаются автоматически при первом сообщении

### Безопасность
- Все запросы требуют аутентификации
- Токены ботов хранятся в зашифрованном виде
- Webhook защищен от несанкционированного доступа

## Устранение неполадок

### Бот не получает сообщения
1. Проверьте, что webhook установлен корректно
2. Убедитесь, что сервер доступен из интернета
3. Проверьте логи сервера на наличие ошибок

### Не удается отправить сообщение
1. Проверьте токен бота в настройках
2. Убедитесь, что бот добавлен к бизнес-аккаунту
3. Проверьте права бота (`can_reply: true`)

### Файлы не загружаются
1. Проверьте размер файла (макс. 50MB для Telegram)
2. Убедитесь, что поддерживается тип файла
3. Проверьте доступность Telegram API

## Расширение функциональности

Для добавления новых возможностей:

1. **Новые типы сообщений**: Обновите `BusinessMessage` модель и обработчики
2. **Дополнительные API**: Добавьте роуты в `business_account_router.py`
3. **UI компоненты**: Расширьте `BusinessChatWindow` и `BusinessChatList`
4. **Webhook события**: Добавьте обработчики в `telegram_webhook_router.py`

## Поддержка

При возникновении проблем:
1. Проверьте логи backend сервера
2. Используйте browser dev tools для отладки frontend
3. Проверьте статус webhook в Telegram Bot API
4. Обратитесь к документации Telegram Bot API: https://core.telegram.org/bots/api


